---
apiVersion: api.cerbos.dev/v1
resourcePolicy:
  version: "default"
  # Importing `common_roles` in so they can be used in the resource policy.
  importDerivedRoles:
    - common_roles

  # This resource file is reviewed for when checking permissions when a resource
  # is of `kind` "task_approval:object"
  resource: "task_approval"

# ┌───────────────┬──────────┬────────────────────────────┬────────────────────┬─────────────────────────────────────────────────────────┬────────────────────────┬──────────────┐
# │ Resource Type │ Action   │ User                       │ Agency User        │ Task Creator                                            │ Manager                │ System Admin │
# ├───────────────┼──────────┼────────────────────────────┼────────────────────┼─────────────────────────────────────────────────────────┼────────────────────────┼──────────────┤
# │ Task Approval │ create   │ if owned tasks is not null │                    │ ✔                                                       │ ✔                     │              │
# │               │ read     │ if owner                   │ if assigned region │ if owner OR assigned task approval OR assigned region   │ ✔                      │ ✔           │
# │               │ update   │ if owner AND status is     │                    │ if (owner OR assigned task approval OR assigned region) │ if status is “pending” │ ✔            │
# │               │          │ “pending”                  │                    │ AND status is “pending”                                 │                        │              │
# │               │ delegate │                            │                    │ if authorized AND assigned region                       │ ✔                      │ ✔           │
# └───────────────┴──────────┴────────────────────────────┴────────────────────┴─────────────────────────────────────────────────────────┴────────────────────────┴──────────────┘

  rules:
    - actions: ["create"]
      effect: EFFECT_ALLOW
      roles:
        - USER
      condition:
        match:
          all:
            of: 
              - expr: R.attr.type == "task_approval_manager"
              - expr: P.attr.owned_tasks != null

    - actions: ["read"]
      effect: EFFECT_ALLOW
      derivedRoles:
        - OWNER

    - actions: ["update"]
      effect: EFFECT_ALLOW
      derivedRoles:
        - OWNER
      condition:
        match:
          expr: R.attr.status == "pending"

    - actions: ["read"]
      effect: EFFECT_ALLOW
      derivedRoles:
        - AGENCY_USER
      condition:
        match:
          expr: R.attr.region == P.attr.region

    - actions: ["create"]
      effect: EFFECT_ALLOW
      derivedRoles:
        - TASK_CREATOR
      condition:
        match:
          expr: R.attr.type == "task_approval_manager"

    - actions: ["read"]
      effect: EFFECT_ALLOW
      derivedRoles:
        - TASK_CREATOR
      condition:
        match:
          any:
            of:
              - expr: R.attr.ownedBy == P.id
              - expr: R.id in P.attr.assigned_task_approvals
              - expr: R.attr.region == P.attr.region
          
    - actions: ["update"]
      effect: EFFECT_ALLOW
      derivedRoles:
        - TASK_CREATOR
      condition:
        match:
          all:
            of:
              - expr: R.attr.ownedBy == P.id || R.id in P.attr.assigned_task_approvals || R.attr.region == P.attr.region
              - expr: R.attr.status == "pending"

    - actions: ["delegate"]
      effect: EFFECT_ALLOW
      derivedRoles:
        - TASK_CREATOR
      condition:
        match:
          all:
            of:
              - expr: P.attr.isAuthorizedToDelegate == true
              - expr: R.attr.region == P.attr.region

    - actions: ["create"]
      effect: EFFECT_ALLOW
      roles:
        - MANAGER
      derivedRoles:
        - SYSTEM_ADMIN
      condition:
        match:
          expr: R.attr.type == "task_approval_manager"

    - actions: ["read", "delegate"]
      effect: EFFECT_ALLOW
      roles:
        - MANAGER
      condition:
        match:
          expr: R.attr.type != "task_approval_manager"

    - actions: ["update"]
      effect: EFFECT_ALLOW
      roles:
        - MANAGER
      condition:
        match:
          expr: R.attr.status == "pending"

    - actions: ["read", "update", "delegate"]
      effect: EFFECT_ALLOW
      derivedRoles:
        - SYSTEM_ADMIN